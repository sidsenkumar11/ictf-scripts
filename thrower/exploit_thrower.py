import os
import random
import subprocess
import threading
import datetime
import time
# Test commit
# TODO: Update Tick

tick_interval = 120 # 4 minutes. May want to make it 1 minute less so can be sure we don't miss a tick
per_minute = 3 # Send 3 exploits per team per minute; could be 3 fakes or 1 real and 2 fakes

def send_real_exploits():
    print '[' + str(datetime.datetime.now().time()) + ']: Sending reals'
    scripts = [x for x in os.listdir('./') if x.startswith('submit_real_')]
    if scripts:
        for script in scripts:
            servicename = script[:-3]
            servicename = servicename[len('submit_real_'):]
            print subprocess.check_output('python ' + script + ' http://api.ictf2019.net/' + ' lVTU84h3IsWsv5Qa48Wv ' + servicename, shell=True)

def main():
    while True:
        real_min = random.randint(0, (tick_interval-60) / 60)
        print "-----------------------------------"
        print "Real min: " + str(real_min)
        print "-----------------------------------"
        for i in range(0, tick_interval, 60):
            time.sleep(60)
            # TODO: Make non-blocking and deal with failures
            if i == real_min*60:
                real_num = random.randint(0, per_minute - 1)
                for j in range(per_minute):
                    if j == real_num:
                        send_real_exploits()
                    else:
                        pass
                        # send_fake_exploits(1)
            else:
                pass

if __name__ == '__main__':
    main()
